<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="caribou-stepper-progress-mixin.html">
<link rel="import" href="caribou-stepper-stepper-property-mixin.html">


<!--
`<caribou-stepper>` is an element used to 

    Example:
        '<caribou-stepper>
        </caribou-stepper>'

    ### Styling The following custom properties and mixins are available for styling: Custom property | Description | Default
    ----------------|-------------|----------

-->
<dom-module id="caribou-stepper">
    <template>
        <style>
             :host {
                display: block;
                --primary-color: #2196F3;
            }
        </style>
        <slot></slot>
    </template>

    <script>
        /**
         * `caribou-stepper`
         * Stepper convey progress through numbered steps.
         *
         * @memberof Caribouflex
         * @mixes Caribouflex.Stepper.ProgressMixin
         * @mixes Caribouflex.Stepper.StepperPropertyMixin
         * @demo demo/index.html
         */
        class CaribouStepperElement extends Caribouflex.Stepper.ProgressMixin(Caribouflex.Stepper.StepperPropertyMixin(
            Polymer.Element)) {

            static get is() {
                return 'caribou-stepper';
            }

            static get properties() {
                return {
                    /**
                     * Contain all the steps registered.
                     */
                    _steps: {
                        type: Array,
                        value: []
                    }
                };
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
            }

            nextStep(e) {
                var step = e.target;
                step.saveStep();
                step.toggleStep();
                step.openNextStep();
            }

            skipStep(e) {
                if (!this.linear) {
                    var step = e.target;
                    step.toggleStep();
                    step.openNextStep();
                } else
                    console.log("can't skip you are in linear mode.");
            }

            _cancelState(e) {
                console.log("cancel");
            }

            connectedCallback() {
                super.connectedCallback();
            }

            _activeChanged(step) {

            }

            closeAllStep() {
                for (var i = 0; i < this._steps.length; i++) {
                    var step = this.getStepById(i);
                    if (step.isActive()) {
                        step.toggleStep();
                    }
                }
            }

            isLastStep() {
                var stepsLength = this._steps.length;
                var saveCpt = 0;
                for (var i = 0; i < this._steps.length; i++) {
                    var step = this.getStepById(i);
                    if (step.save) {
                        saveCpt++;
                    }
                }

                if (stepsLength - 1 === saveCpt)
                    return true;
                else
                    return false;
            }

            _validStepper() {
                var done = true; //true if all step are valid.
                for (var i = 0; i < this._steps.length; i++) {
                    var step = this.getStepById(i);
                    if (!step.save) {
                        done = false;
                        step.toggleStep(this.isLastStep());
                        break;
                    }
                }

                if (done) {
                    console.log("caribou-stepper finished.");
                    this.dispatchEvent(new CustomEvent('stepper-finished', {
                        bubbles: true,
                        composed: true
                    }));
                }
            }

            /**
             * This function is used to return the step element 
             * situated at the specific ID.
             * @param {Number} id The id of the step to retrieve
             * @return {Object} The stepper object.
             */
            getStepById(id) {
                return this.get(['_steps', id])
            }

            _registerStep(element) {
                this.push('_steps', element);
                element.addEventListener("last-step-closed", this._validStepper.bind(this));
                element.addEventListener("continue-clicked", this.nextStep.bind(this));
                element.addEventListener("finish-clicked", this.nextStep.bind(this));
                element.addEventListener("skip-clicked", this.skipStep.bind(this));
                element.addEventListener("update-clicked", this.nextStep.bind(this));
            }
        }

        window.customElements.define(CaribouStepperElement.is, CaribouStepperElement);

        /**
         * @namespace Caribouflex
         */
        window.Caribouflex = window.Caribouflex || {};
        Caribouflex.CaribouStepperElement = CaribouStepperElement;
    </script>
</dom-module>