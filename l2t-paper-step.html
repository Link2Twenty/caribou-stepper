<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<dom-module id="l2t-paper-step">
  <template>
    <style>
      .layout {
        border-left: 1px solid var(--step-connector-line-color, var(--divider-color));
        margin-left: calc((var(--step-badge-width, 30px)/2) + 9.12px);
        padding: 0 31.12px;
      }

      .layout .content {
        padding: 10px 0;
      }

      .layout paper-button {
        margin: 0;
        background-color: var(--step-button-color, var(--primary-color));
        --paper-button-ink-color: var(--step-button-color, var(--button-ink-color));
        color: var(--step-button-text-color, #fff);
      }

      .toggleHdr {
        display: flex;
        justify-content: flex-start;
        margin: 0;
      }

      :host([optional]) .subtitle {
        font-size: .8em;
        margin-top: 2px;
      }

      :host([save]) .labelBtn {
        color: var(--step-saved-label-color, var(--primary-text-color));
      }

      :host([locked]) .labelBtn {
        color: var(--step-locked-label-color, var(--disabled-text-color));
      }

      :host([active]) .labelBtn,
      :host([save][active]) .labelBtn {
        color: var(--step-active-label-color, var(--primary-text-color));
        font-weight: 600
      }

      .labelBtn {
        align-self: center;
        padding: 0 16px;
        color: var(--step-label-color, var(--disabled-text-color))
      }

      :host .iconBtn {
        display: none;
      }

      :host([active]) .badgeNumber {
        background-color: var(--step-active-badge-color, var(--primary-color))
      }

      :host([save]) .iconBtn {
        background-color: var(--step-save-badge-color, var(--primary-color))
      }

      :host([locked]) .iconBtn {
        background-color: var(--step-locked-badge-color, var(--disabled-text-color))
      }

      :host([locked]) .iconBtn,
      :host([save]) .iconBtn {
        display: block
      }

      :host([locked]) .badgeNumber,
      :host([save]) .badgeNumber {
        display: none
      }

      .iconBtn,
      .badgeNumber {
        --iron-icon-height: calc(var(--step-badge-height, 30px) - 12px);
        --iron-icon-width: calc(var(--step-badge-height, 30px) - 12px);
        width: calc(var(--step-badge-height, 30px) - 12px);
        height: calc(var(--step-badge-height, 30px) - 12px);
        text-align: center;
        border-radius: 50%;
        padding: 6px;
        background-color: var(--step-badge-color, var(--secondary-text-color));
        color: var(--step-badge-content-color, var(--primary-background-color))
      }
    </style>

    <paper-button class="toggleHdr" on-tap="_setValidActive">
      <iron-icon class="iconBtn" icon="[[_getIcon(editable, save, locked)]]"></iron-icon>
      <span class="badgeNumber">{{_badgeNum(stepIndex)}}</span>
      <div class="labelBtn">{{label}}
        <template is="dom-if" if="{{optional}}">
          <div class="subtitle">OPTIONAL</div>
        </template>
      </div>
    </paper-button>
    <div class="layout">
      <iron-collapse opened="{{active}}">
        <div class="content">
          <slot></slot>
        </div>
        <template is="dom-if" if="{{!parentElement.finish}}">
          <template is="dom-if" if="{{save}}">
            <paper-button data-event="update" on-tap="_fireEvent">{{updateLabel}}</paper-button>
          </template>
          <template is="dom-if" if="{{_showContinue(active)}}">
            <paper-button data-event="continue" on-tap="_fireEvent">{{continueLabel}}</paper-button>
          </template>
          <template is="dom-if" if="{{skipButton}}">
            <paper-button data-event="skip" on-tap="_fireEvent">{{skipLabel}}</paper-button>
          </template>
          <template is="dom-if" if="{{_showFinish(active)}}">
            <paper-button data-event="finish" on-tap="_fireEvent">{{finishLabel}}</paper-button>
          </template>
          <template is="dom-if" if="{{backButton}}">
            <paper-button data-event="back" on-tap="_fireEvent">{{backLabel}}</paper-button>
          </template>
        </template>
      </iron-collapse>
    </div>
  </template>

  <script>
    /**
     * `<l2t-paper-step>` is an element that need to be surrounded by a `<l2t-paper-stepper>` element.
     * 
     * This element correspond correspond to one step in the stepper.
     * It can be Editable and Optional. 
     * 
     * Example:
     * ```html
     * <l2t-paper-step label="Information" skip-button optional>
     * ...
     * </l2t-paper-step>
     * ```
     * 
     * ### Styling The following custom properties and mixins are available for styling: 
     * 
     * Custom property | Description | Default
     * ----------------|-------------|----------
     * `--step-connector-line-color` | Color of the line that connect the steps | `#BDBDBD` 
     * `--step-saved-label-color` | Color of the label once it's saved | `#424242`
     * `--step-active-label-color`| Color of the label when the step is active | `#424242`
     * `--step-label-color`| Initial color of the label | `#E0E0E0`
     * `--step-badge-height`| The height of the badge (without border) | `18px`
     * `--step-badge-width`| The width of the badge (without border) | `18px`
     * `--step-save-badge-color`| Color of the badge once the step is saved | `--primary-color`
     * `--step-badge-color`| Initial color of the badge | `#9E9E9E`
     * `--step-badge-content-color`| Color of the number and the icon inside the badge | `#FFFFFF`
     * 
     * @element l2t-paper-step
     */
    class L2tPaperStep extends Polymer.Element {
      /**
       * Fired when the step is invalid to the validation the user defined.
       * @event step-invalid
       * @param {Object} detail empty
       */

      static get is() { return 'l2t-paper-step'; }

      static get properties() {
        return {
          ///////////////// Public properties /////////////////
          /**
          * Boolean: indicating if the step is currently active
          */
          active: {
            type: Boolean,
            reflectToAttribute: true,
            observer: 'activeStepObserver'
          },
          /**
           * Boolean: indicates if back button should be shown
           */
          backButton: {
            type: Boolean
          },
          /**
           * String: label for back button
           */
          backLabel: {
            type: String,
            value: "Back"
          },
          /**
           * String: label for continue button
           */
          continueLabel: {
            type: String,
            value: "Continue"
          },
          /**
           * Boolean: indicating if the step is editable.
           */
          editable: {
            type: Boolean
          },
          /**
           * String: label for finish button
           */
          finishLabel: {
            type: String,
            value: "Finish"
          },
          /**
           * String: label for step
           */
          label: {
            type: String
          },
          /**
           * Boolean: indicating if the step is locked.
           */
          locked: {
            type: Boolean
          },
          /**
           * Boolean: indicating if the step is optional.
           */
          optional: {
            type: Boolean
          },
          /**
          * Boolean: indicating if the step is saved.
          */
          save: {
            type: Boolean,
            reflectToAttribute: true
          },
          /**
           * Boolean: indicates if skip button should be shown
           */
          skipButton: {
            type: Boolean,
            reflectToAttribute: true
          },
          /**
           * String: label for skip button
           */
          skipLabel: {
            type: String,
            value: "Skip"
          },
          /**
          * Number: stores own index in _steps array
          **/
          stepIndex: {
            type: Number
          },
          /**
           * String: label for update button
           */
          updateLabel: {
            type: String,
            value: "Update"
          },
          /**
          * Boolean: indicating if the step is valid.
          **/
          valid: {
            type: Boolean,
            value: true
          },
          //////////////// Private properties ////////////////
          /**
           * String: name of icon to be used.
           */
          _icon: {
            type: String,
            value: 'check'
          }
        };
      }
      ////////////////// Public functions //////////////////
      /**
      * Observer for active to set _activeStepIndex
      **/
      activeStepObserver() {
        if (this.active)
          this.parentElement._activeStepIndex = this.stepIndex;
      }
      /**
      * fire step-invalid event
      **/
      fireInvalidStep() {
        this.dispatchEvent(new CustomEvent('step-invalid', { bubbles: true, composed: true }));
      }
      /**
      * Register step with parent
      */
      ready() {
        super.ready();
        this.parentElement._registerStep(this);
      }
      /**
      * set back to initial state 
      */
      reset() {
        this.save = false;
        this.active = false;
        this.$.stepButtons.reset();

        if (this.stepIndex === 0 && this.parentElement.opened)
          this.active = true;
      }
      ///////////////// Private functions /////////////////
      /**
      * Returns the badge number
      **/
      _badgeNum(i) {
        return i + 1;
      }
      /**
       * This is a callback function called when one of the different button is clicked.
       * @param {Object} e The event object
       */
      _fireEvent(e) {
        this.dispatchEvent(new CustomEvent(`${e.currentTarget.dataset.event}-clicked`, { bubbles: true, composed: true }));
      }
      /**
       * returns the correct icon name
       */
      _getIcon() {
        return this.locked ? "lock-outline" : this.editable ? "create" : "check";
      }
      /**
       * makes self active step
       */
      _setActive() {
        this.parentElement.closeAll();
        this.active = true;
      }
      /**
      * checks if can be set to active, if passes sets to active
      **/
      _setValidActive() {
        // if already active, locked or saved but not editable quit
        if (this.active || this.locked || (this.save && !this.editable))
          return;
        // if parent is linear and step is ahead of active step or parent is finished quit
        if ((this.parentElement.linear && this.stepIndex > this.parentElement._activeStepIndex && !this.save) || this.parentElement.finish)
          return;

        this._setActive();
      }
      /**
      * returns true if continue button should be shown
      **/
      _showContinue() {
        return !(this.parentElement.isFinalStep() || this.save);
      }
      /**
      * returns true if finish button should be shown
      **/
      _showFinish() {
        return this.parentElement.isFinalStep();
      }
    }

    window.customElements.define(L2tPaperStep.is, L2tPaperStep);
  </script>
</dom-module>