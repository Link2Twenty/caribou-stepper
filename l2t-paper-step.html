<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="l2t-paper-step-action-buttons.html">

<dom-module id="l2t-paper-step">
  <template>
    <style>
      :host {
        height: inherit
      }

      div.layout {
        border-left: 1px solid var(--step-connector-line-color, #BDBDBD);
        margin-left: 24px;
        padding: 10px 28px
      }

      paper-button {
        display: flex;
        margin: 0;
        justify-content: flex-start;
        text-align: center;
        position: relative
      }

      :host([optional]) span#subtitle {
        display: block;
        font-size: .8em;
        margin-top: 2px;
      }

      :host([save]) div#labelBtn {
        color: var(--step-saved-label-color, #424242);
        font-weight: inherit
      }

      :host([locked]) div#labelBtn {
        color: var(--step-locked-label-color, var(--step-saved-label-color));
        font-weight: inherit
      }

      :host([active]) div#labelBtn,
      :host([save][active]) div#labelBtn {
        color: var(--step-active-label-color, #424242);
        font-weight: 600
      }

      div#labelBtn {
        align-self: center;
        padding: 0 16px;
        font-size: 14sp;
        color: var(--step-label-color, #E0E0E0)
      }

      :host iron-icon#iconBtn {
        display: none;
      }

      :host([save]) iron-icon#iconBtn {
        display: block;
        border-color: var(--step-save-badge-color, var(--primary-color));
        background-color: var(--step-save-badge-color, var(--primary-color))
      }

      :host([locked]) iron-icon#iconBtn {
        display: block;
        border-color: var(--step-locked-badge-color, var(--disabled-text-color));
        background-color: var(--step-locked-badge-color, var(--disabled-text-color))
      }

      :host([locked]) span.badgeNumber,
      :host([save]) span.badgeNumber {
        display: none
      }

      span.badgeNumber {
        @apply --layout-horizontal;
        @apply --layout-center-justified;
        @apply --layout-center;
        width: var(--step-badge-width, 18px);
        height: var(--step-badge-height, 18px)
      }

      iron-icon#iconBtn,
      span.badgeNumber {
        --iron-icon-height: 18px;
        --iron-icon-width: 18px;
        border-radius: 50%;
        padding: 6px;
        background-color: var(--step-badge-color, var(--secondary-text-color));
        color: var(--step-badge-content-color, var(--primary-background-color))
      }

      l2t-paper-step-action-buttons paper-button {
        @apply --button-style;
      }
    </style>

    <paper-button on-tap="_toggle">
      <iron-icon id="iconBtn" icon="[[_icon]]"></iron-icon>
      <span class="badgeNumber">{{_badgeNum(stepIndex)}}</span>
      <div id="labelBtn">{{label}}
        <template is="dom-if" if="{{optional}}">
          <span id="subtitle">OPTIONAL</span>
        </template>
      </div>
    </paper-button>
    <div class="layout">
      <iron-collapse id="stepContent" opened="{{active}}">
        <slot></slot>
        <l2t-paper-step-action-buttons id="stepButtons" continue-label="[[continueLabel]]" finish-label="[[finishLabel]]" update-label="[[updateLabel]]"
          skip-label="[[skipLabel]]" skip-button="[[skipButton]]" back-label="[[backLabel]]" back-button="[[backButton]]"></l2t-paper-step-action-buttons>
      </iron-collapse>
    </div>
  </template>

  <script>
    /**
     * `<l2t-paper-step>` is an element that need to be surrounded by a `<l2t-paper-stepper>` element.
     * 
     * This element correspond correspond to one step in the stepper.
     * It can be Editable and Optional. 
     * 
     * Example:
     * ```html
     * <l2t-paper-step label="Information" skip-button optional>
     * 	<paper-input always-float-label label="Surname"></paper-input>
     * 	<paper-input label="username">
     * 		<iron-icon icon="mail" slot="prefix"></iron-icon>
     * 		<div slot="suffix">@email.com</div>
     * 	</paper-input>
     * </l2t-paper-step>
     * ```
     * 
     * ### Styling The following custom properties and mixins are available for styling: 
     * 
     * For the `--step-badge-width` and the `--step-badge-height`, there is a border (6px) added to the badge that could not be changed.
     * 
     * Custom property | Description | Default
     * ----------------|-------------|----------
     * `--step-connector-line-color` | Color of the line that connect the steps | `#BDBDBD` 
     * `--step-saved-label-color` | Color of the label once it's saved | `#424242`
     * `--step-active-label-color`| Color of the label when the step is active | `#424242`
     * `--step-label-color`| Initial color of the label | `#E0E0E0`
     * `--step-badge-height`| The height of the badge (without border) | `18px`
     * `--step-badge-width`| The width of the badge (without border) | `18px`
     * `--step-save-badge-color`| Color of the badge once the step is saved | `--primary-color`
     * `--step-badge-color`| Initial color of the badge | `#9E9E9E`
     * `--step-badge-content-color`| Color of the number and the icon inside the badge | `#FFFFFF`
     * 
     * @element l2t-paper-step
     */
    class L2tPaperStep extends Polymer.Element {

      /**
       * Fired when the last step has been finished.
       * This event is declared in the 'StepPropertyMixin'.
       * Bubble event.
       *
       * @event last-step-closed
       * @param {Object} detail empty
       */

      /**
       * Fired when the step is invalid to the validation the user defined.
       *
       * @event step-invalid
       * @param {Object} detail empty
       */

      static get is() {
        return 'l2t-paper-step';
      }

      static get properties() {
        return {
          /**
           * This is the label of the step
           */
          label: {
            type: String
          },
          /**
           * This stores a boolean value
           * indicating if the step is locked.
           */
          locked: {
            type: Boolean,
            observer: '_getIcon'
          },
          /**
           * This stores a boolean value
           * indicating if the step is editable.
           */
          editable: {
            type: Boolean,
            observer: '_getIcon'
          },
          /**
          *
          **/
          valid: {
            type: Boolean,
            value: true
          },
          /**
           * This stores a string containing
           * the correct icon to be used.
           */
          _icon: {
            type: String,
            value: 'check'
          },
          /**
          * Property used to indicate if the step is saved.
          * True if it's saved, false otherwise.
          */
          save: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          /**
           * Property used to indicate if the step is optional.
           * True if it's optional, false otherwise.
           */
          optional: {
            type: Boolean,
            value: false
          },
          /**
           * Property used to indicate if the step is active.
           * If the step is active that means it will be open, and it's the current step we are focused on.
           * True if it's active, false otherwise.
           */
          active: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            observer: 'activeStepObserver'
          },
          /**
           * The continue button text value
           * 'Continue' by default
           */
          continueLabel: {
            type: String,
            value: "Continue"
          },
          /**
           * The finish button text value
           * 'Finish' by default
           */
          finishLabel: {
            type: String,
            value: "Finish"
          },
          /**
           * The update button text value
           * 'Update' by default
           */
          updateLabel: {
            type: String,
            value: "Update"
          },
          /**
           * The skip button text value
           * 'Skip' by default
           */
          skipLabel: {
            type: String,
            value: "Skip"
          },
          /**
           * True to display the skip button, false otherwise.
           * If the step is linear, the skip button will do nothing, except if the property Optional is true.
           */
          skipButton: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          /**
           * The back button text value
           * 'Back' by default
           */
          backLabel: {
            type: String,
            value: "Back"
          },
          /**
           * True to display the back button, false otherwise.
           */
          backButton: {
            type: Boolean,
            value: false
          },
          /**
          *
          **/
          stepIndex: Number
        };
      }

      /**
       * In this ready function, we will take care of oppening the step if it's the first one 
       * And if the parameter is set for.
       * Then we will call the register function, which is used to register a step into the stepper.
       */
      ready() {
        super.ready();
        this.parentElement._registerStep(this);
      }

      /**
       * This is a callback function called whent the step title is clicked.
       * This will close all the open steps before opening the one selected, if the criteria are respected.
       * Moreover, if we are in a case of a modification, we will display the update button.
       * @private
       */
      _toggle() {
        // if already active, locked or saved but not editable quit
        if (this.active || this.locked || (this.save && !this.editable))
          return;
        // if parent is linear and step is ahead of active step or parent is finished quit
        if ((this.parentElement.linear && this.stepIndex > this.parentElement.activeStepIndex) || this.parentElement.finish)
          return;
        
        this.parentElement.closeAll();
        this.active = true;
        this.$.stepButtons.setUpdate(this.save && this.editable);
        this.$.stepButtons.setFinish(this.parentElement.isFinalStep());
      }

      _badgeNum(i) {
        return i + 1;
      }

      /**
       * This function is used to get the good icon to display into the badge,
       * accordign to the 'editable' property.
       * @private
       */
      _getIcon() {
        let icon = "check";
        if (this.locked) {
          icon = "lock-outline";
        } else if (this.editable) {
          icon = "create"
        }
        this._icon = icon;
      }

      /**
       * This function is used to reinitialize all the parameter of this element 
       * and the action buttons
       */
      reset() {
        this.removeAttribute("save");
        this.active = false;
        this.$.stepButtons.reset();
        this.updateStyles();

        if (this.parentElement.opened) {
          if (this.stepIndex === 0)
            this.active = true;
        }
      }

      activeStepObserver() {
        this.$.stepButtons.setFinish(this.parentElement.isFinalStep());
        if (this.active)
          this.parentElement.activeStepIndex = this.stepIndex;
      }

      fireInvalidStep() {
        this.dispatchEvent(new CustomEvent('step-invalid', {
          bubbles: true,
          composed: true
        }));
      }
    }

    window.customElements.define(L2tPaperStep.is, L2tPaperStep);
  </script>
</dom-module>