<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="l2t-paper-stepper">
  <template>
    <style></style>
    <slot></slot>
  </template>
  <script>
    /**
     * `<l2t-paper-stepper>` is an element used to display progress through a sequence of logical and numbered steps.
     * This element needs to be used with the `l2t-paper-step` element.
     *     
     * Example:
     * ```html
     * <l2t-paper-stepper opened>
     *     <l2t-paper-step>...</l2t-paper-step>
     *     <l2t-paper-step>...</l2t-paper-step>
     *     <l2t-paper-step>...</l2t-paper-step>
     * </l2t-paper-stepper>
     * ```
     * 
     * @demo demo/index.html
     * @element l2t-paper-stepper
     */
    class L2tPaperStepper extends Polymer.Element {
      static get is() { return 'l2t-paper-stepper'; }

      static get properties() {
        return {
          ///////////////// Public properties /////////////////
          /**
          * Boolean: Used to indicate if the stepper is finished or not.
          */
          finish: {
            type: Boolean,
            value: false
          },
          /**
          * Boolean: Used to indicate if the stepper require users to complete one step in order to move on to the next.
          */
          linear: {
            type: Boolean,
            value: true
          },
          /**
          * Boolean: If true, after the stepper is loaded, first step be opened.
          */
          opened: {
            type: Boolean,
            value: false
          },
          //////////////// Private properties ////////////////
          /**
          * Number: Contains the index of the active step
          */
          _activeStepIndex: {
            type: Number,
            value: 0
          },
          /**
          * Array: Contains all the steps registered.
          */
          _steps: {
            type: Array,
            value: []
          }
        }
      }
      ////////////////// Public functions //////////////////
      /**
      * This function is used to close all the steps.
      */
      closeAll() {
        for (let step of this._steps) {
          step.active = false;
        }
      }
      /**
      *
      */
      isFinalStep() {
        let count = 0;
        for (let step of this._steps) {
          if (!step.save && !step.locked && !step.active)
            count++
        }

        return !count;
      }
      /**
      * This function is used to open the next step.
      * It will save and close the current active step.
      * Then it will open the next step, if there is one.
      */
      nextStep() {
        let currStep = this._steps[this._activeStepIndex];
        // Check valid is true
        if (currStep.valid) {
          // Save current step
          currStep.save = true;
          // Calculate next step
          let nextIndex = this._calcNextStep();
          // if there are 0 valid steps quit
          if (nextIndex === null)
            return
            
          this._steps[nextIndex]._setActive();
        } else {
          currStep.fireInvalidStep();
        }
      }
      /**
      * This function is used to open the previous step.
      * It will close, but not save, the current active step.
      * Then it will open the previous step, if there is one.
      */
      prevStep() {
        let currStep = this._steps[this._activeStepIndex];
        // Calculate next step
        let prevStep = this._calcPrevStep();
        // if there are 0 valid steps quit
        if (prevStep === null)
          return

        this._steps[prevStep]._setActive();
      }
      /**
       * This function is used to reinitialize all the parameter of this element 
       * and from all the steppers.
       */
      reset() {
        this._setIsResetting(true);
        this.finish = false;
        this.activeStep = undefined;
        this.nextStep = undefined;
        for (var i = 0; i < this._steps.length; i++) {
          var step = this._steps[i];
          step.reset(this.opened);
        }
        this._setIsResetting(false);
      }
      /**
      * This function is used to set the active step by number/index.
      * @param {Number} i is an index.
      */
      setActiveByIndex(i) {
        // Catch out of range Indexes
        if (i >= this._steps.length || i < 0)
          return;

        this._steps[i]._setActive();
      }
      /**
      * This function is used to skip the current active step.
      */
      skipStep() {
        if ((this.linear && this._steps[this._activeStepIndex].optional) || !this.linear) {
          if (this.linear)
            this._steps[this._activeStepIndex].save = true;
          this._steps[this._activeStepIndex].toggleStep();
          if (this.nextStep !== null)
            this.nextStep.toggleStep();
        } else {
          console.log("can't skip you are in linear mode.");
        }
      }
      ///////////////// Private functions /////////////////
      /*
      * Calculates previous valid step
      */
      _calcPrevStep() {
        let stepIndex = this._activeStepIndex == 0 ? this._steps.length : this._activeStepIndex - 1;
        let prevIndex = null;
        while (stepIndex != this._activeStepIndex) {
          let checkStep = this._steps[stepIndex];
          if (checkStep.locked || checkStep.save) {
            stepIndex = stepIndex == 0 ? this._steps.length : stepIndex - 1;
          } else {
            prevIndex = stepIndex;
            stepIndex = this._activeStepIndex;
          }
        }
        return prevIndex
      }
      /*
      * Calculates next valid step
      */
      _calcNextStep() {
        let stepIndex = (this._activeStepIndex + 1) % this._steps.length;
        let nextIndex = null;
        while (stepIndex != this._activeStepIndex) {
          let checkStep = this._steps[stepIndex];
          if (checkStep.locked || checkStep.save) {
            stepIndex = (stepIndex + 1) % this._steps.length;
          } else {
            nextIndex = stepIndex;
            stepIndex = this._activeStepIndex;
          }
        }
        return nextIndex
      }
      /**
       * This is a private callback function used to skip the current state and open the next one.
       * This can be done only if we are in linear mode.
       */
      _finishStep(e) {
        let currStep = this._steps[this._activeStepIndex];
        if (currStep.valid) {
          currStep.save = true
          this.closeAll();
          this.finish = true;
          this.dispatchEvent(new CustomEvent('stepper-finished', {
            bubbles: true,
            composed: true
          }));
        } else {
          currStep.fireInvalidStep();
        }
      }
      /**
       * This function is used by the `l2t-paper-step` to register into the `l2t-paper-stepper`.
       * All elements registered are added into the _steps property.
       */
      _registerStep(el) {
        this._steps.push(el);
        el.stepIndex = this._steps.length - 1;
        if (el.stepIndex == 0 && this.opened)
          el.active = true
        el.addEventListener("last-step-closed", this.nextStep.bind(this));
        el.addEventListener("continue-clicked", this.nextStep.bind(this));
        el.addEventListener("finish-clicked", this._finishStep.bind(this));
        el.addEventListener("skip-clicked", this.skipStep.bind(this));
        el.addEventListener("back-clicked", this.prevStep.bind(this));
        el.addEventListener("update-clicked", this.nextStep.bind(this));

        for (let step of this._steps) {
          step.activeStepObserver();
        }
      }
    }

    window.customElements.define(L2tPaperStepper.is, L2tPaperStepper);
  </script>
</dom-module>