<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="l2t-paper-stepper">
  <template>
    <slot></slot>
  </template>
  <script>
    /**
     * `<l2t-paper-stepper>` is an element used to display progress through a sequence of logical and numbered steps.
     * This element needs to be used with the `l2t-paper-step` element.
     *     
     * Example:
     * ```html
     * <l2t-paper-stepper>
     *     <l2t-paper-step>...</l2t-paper-step>
     *     <l2t-paper-step>...</l2t-paper-step>
     * </l2t-paper-stepper>
     * ```
     * 
     * @demo demo/index.html
     * @element l2t-paper-stepper
     */
    class L2tPaperStepper extends Polymer.Element {
      static get is() { return 'l2t-paper-stepper'; }

      static get properties() {
        return {
          ///////////////// Public properties /////////////////
          /**
          * Boolean: Used to indicate if the stepper is finished or not.
          */
          finish: {
            type: Boolean,
            value: false
          },
          /**
          * Boolean: Used to indicate if the stepper require users to complete one step in order to move on to the next.
          */
          nonLinear: {
            type: Boolean,
            value: false
          },
          /**
          * Boolean: If true, start with all steps closed.
          */
          closed: {
            type: Boolean,
            value: false
          },
          //////////////// Private properties ////////////////
          /**
          * Number: Contains the index of the active step
          */
          _activeStepIndex: {
            type: Number,
            value: null
          },
          /**
          * Array: Contains all the steps registered.
          */
          _steps: {
            type: Array,
            value: []
          }
        }
      }
      ////////////////// Public functions //////////////////
      /**
      * Function: used to close all the steps
      */
      closeAll() {
        for (let step of this._steps) {
          step.active = false;
        }
      }
      /**
      * Return: used to inicate is current step is the final step
      */
      isFinalStep() {
        let count = 0;
        for (let step of this._steps) {
          if (!step.save && !step.locked && !step.active)
            count++
        }
        return !count;
      }
      /**
      * Function: used to open the next step, it will save and close the current step
      */
      nextStep() {
        let currStep = this._steps[this._activeStepIndex];
        // Check valid is true
        if (currStep.valid) {
          // Save current step
          currStep.save = true;
          // Calculate next step
          let nextIndex = this._calcNextStep();
          // if there are 0 valid steps quit
          if (nextIndex === null)
            return

          this._steps[nextIndex]._setActive();
        } else {
          currStep.fireInvalidStep();
        }
      }
      /**
      * Function: used to open the previous step, it will close, not save, the current step
      */
      prevStep() {
        let currStep = this._steps[this._activeStepIndex];
        // Calculate next step
        let prevStep = this._calcPrevStep();
        // if there are 0 valid steps quit
        if (prevStep === null)
          return

        this._steps[prevStep]._setActive();
      }
      /**
       * Function: used to unsave all steps
       */
      reset() {
        this.finish = false;
        this._activeStepIndex = null;
        for (let step of this._steps) {
          step.active = false;
          step.save = false;
        }
        this.closed || this._steps[0]._setActive();
      }
      /**
      * Function: used to set the active step by number/index.
      */
      setActiveByIndex(i) {
        // Catch out of range Indexes
        if (i >= this._steps.length || i < 0)
          return;

        this._steps[i]._setActive();
      }
      /**
      * Function: used to open the next step, it will close, not save, the current step
      */
      skipStep() {
        let nextIndex = this._calcNextStep();
        // if there are 0 valid steps quit
        if (nextIndex === null)
          return

        this._steps[nextIndex]._setActive();
      }
      ///////////////// Private functions /////////////////
      /*
      * Return: provides the index closest valid step, going forwards through the array
      */
      _calcNextStep() {
        let stepIndex = (this._activeStepIndex + 1) % this._steps.length;
        let nextIndex = null;
        while (stepIndex != this._activeStepIndex) {
          let checkStep = this._steps[stepIndex];
          if (checkStep.locked || checkStep.save) {
            stepIndex = (stepIndex + 1) % this._steps.length;
          } else {
            nextIndex = stepIndex;
            stepIndex = this._activeStepIndex;
          }
        }
        return nextIndex
      }
      /*
      * Return: provides the index closest valid step, going backwards through the array
      */
      _calcPrevStep() {
        let stepIndex = this._activeStepIndex == 0 ? this._steps.length : this._activeStepIndex - 1;
        let prevIndex = null;
        while (stepIndex != this._activeStepIndex) {
          let checkStep = this._steps[stepIndex];
          if (checkStep.locked || checkStep.save) {
            stepIndex = stepIndex == 0 ? this._steps.length : stepIndex - 1;
          } else {
            prevIndex = stepIndex;
            stepIndex = this._activeStepIndex;
          }
        }
        return prevIndex
      }
      /**
      * Function: used to fire stepper-finished
      **/
      _finishStep() {
        let currStep = this._steps[this._activeStepIndex];
        if (currStep.valid) {
          currStep.save = true
          this.closeAll();
          this.finish = true;
          this.dispatchEvent(new CustomEvent('stepper-finished', { bubbles: true, composed: true }));
        } else {
          currStep.fireInvalidStep();
        }
      }
      /**
       * Function: used by `l2t-paper-step` to add itself into the _steps array
       */
      _registerStep(el) {
        this._steps.push(el);
        el.stepIndex = this._steps.length - 1;
        el.addEventListener("continue-clicked", this.nextStep.bind(this));
        el.addEventListener("finish-clicked", this._finishStep.bind(this));
        el.addEventListener("skip-clicked", this.skipStep.bind(this));
        el.addEventListener("back-clicked", this.prevStep.bind(this));
        el.addEventListener("update-clicked", this.nextStep.bind(this));
        this.closed || this._steps[0]._setActive();
      }
    }

    window.customElements.define(L2tPaperStepper.is, L2tPaperStepper);
  </script>
</dom-module>